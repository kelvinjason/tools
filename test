import org.apache.pdfbox.cos.COSName;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDPageContentStream;
import org.apache.pdfbox.pdmodel.font.PDType1Font;
import org.apache.pdfbox.text.PDFTextStripper;
import org.apache.pdfbox.text.TextPosition;

import java.io.File;
import java.io.IOException;
import java.util.List;

public class PDFPlaceholderReplacer {

    public static void main(String[] args) {
        String templatePath = "path/to/your/template.pdf";
        String outputPath = "path/to/output/filled.pdf";

        try (PDDocument document = PDDocument.load(new File(templatePath))) {
            PlaceholderPDFTextStripper stripper = new PlaceholderPDFTextStripper("<name>", "kelvin");
            stripper.setSortByPosition(true);

            // 遍历每一页并处理占位符
            for (PDPage page : document.getPages()) {
                stripper.setStartPage(document.getPages().indexOf(page) + 1);
                stripper.setEndPage(document.getPages().indexOf(page) + 1);
                stripper.replaceText(document, page);
            }

            document.save(outputPath);
            System.out.println("PDF placeholders replaced and saved successfully.");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    static class PlaceholderPDFTextStripper extends PDFTextStripper {

        private final String placeholder;
        private final String replacement;

        public PlaceholderPDFTextStripper(String placeholder, String replacement) throws IOException {
            this.placeholder = placeholder;
            this.replacement = replacement;
        }

        public void replaceText(PDDocument document, PDPage page) throws IOException {
            this.setSortByPosition(true);
            this.setStartPage(document.getPages().indexOf(page) + 1);
            this.setEndPage(document.getPages().indexOf(page) + 1);

            String content = this.getText(document);
            if (content.contains(placeholder)) {
                content = content.replace(placeholder, replacement);

                // 清空页面内容
                page.getCOSObject().setItem(COSName.CONTENTS, null);

                try (PDPageContentStream contentStream = new PDPageContentStream(document, page)) {
                    contentStream.setFont(PDType1Font.HELVETICA, 12);
                    contentStream.beginText();
                    contentStream.newLineAtOffset(25, 725);

                    // 按行处理文本
                    String[] lines = content.split("\r?\n");
                    for (String line : lines) {
                        contentStream.showText(line);
                        contentStream.newLineAtOffset(0, -15);
                    }

                    contentStream.endText();
                }
            }
        }
    }
}
